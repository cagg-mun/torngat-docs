

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>… run E3d on Torngat &mdash; Torngat cluster  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="… run unusual code on Torngat" href="../unusual.html" />
    <link rel="prev" title="MPI Communications" href="../impi/mpi-helloworld.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Torngat cluster
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">How do I …</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../getatorngataccount.html">… get a Torngat account?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transferdatatoacenet.html">… transfer data to/from ACE-net</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../transferdatatoacenet.html#tips">Tips</a></li>
<li class="toctree-l3"><a class="reference internal" href="../transferdatatoacenet.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pickaparallelenvironment.html">… pick a parallel environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../pickaparallelenvironment.html#pe-configuration">PE Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pickaparallelenvironment.html#torngat-pes">Torngat PEs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../matlab.html">… run MATLAB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../matlab.html#accessing-a-matlab-node">Accessing a MATLAB node</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../matlab.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../matlab.html#access-instructions">Access instructions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../matlab.html#parallel-computing-in-matlab">Parallel computing in MATLAB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../submit.html">… submit a job on Torngat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../useimpi.html">… run Intel MPI programs on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../impi/1selectmpi.html">Select MPI version</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../impi/1selectmpi.html#use-the-mpi-selector-facility-to-set-the-mpi-version-to-intel-mpi">Use the mpi selector facility to set the MPI version to Intel MPI.</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../impi/2compile.html">Use the mpi compiler to compile the MPI program</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../impi/2compile.html#see-sample-program">See Sample program</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../impi/2compile.html#compile-c-program">Compile C program:</a></li>
<li class="toctree-l5"><a class="reference internal" href="../impi/2compile.html#compile-c-c-program">Compile C/C++ program:</a></li>
<li class="toctree-l5"><a class="reference internal" href="../impi/2compile.html#compile-fortran-program">Compile Fortran program:</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../impi/2compile.html#switches-on-the-command-line-are-passed-to-the-underlying-compiler">Switches on the command line are passed to the underlying compiler.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../impi/3submit.html">To run a program in the Intel MPI environment:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../impi/3submit.html#create-a-script-file-describing-the-job">Create a script file describing the job:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../impi/4monitor.html">Monitoring Jobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../impi/4monitor.html#to-show-your-jobs">To show your jobs:</a></li>
<li class="toctree-l4"><a class="reference internal" href="../impi/4monitor.html#to-show-all-jobs">To show all jobs:</a></li>
<li class="toctree-l4"><a class="reference internal" href="../impi/4monitor.html#to-show-all-queues">To show all queues:</a></li>
<li class="toctree-l4"><a class="reference internal" href="../impi/4monitor.html#to-delete-abort-a-job">To delete (abort) a job:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../impi/5output.html">Get the output from the completed job.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../impi/6sample.html">Sample Programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../impi/mpi-helloworld.html">MPI Communications</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">… run E3d on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-run-e3d-on-torngat">How to run E3d on Torngat</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../unusual.html">… run unusual code on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../unusual.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../unusual.html#the-code">“The Code”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../unusual.html#how-to-run-it-on-torngat">How to run it on torngat</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../impi/mpi-helloworld.html">MPI Communications</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Torngat cluster</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">How do I …</a> &raquo;</li>
        
      <li>… run E3d on Torngat</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/howdoi/e3d/e3d.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="run-e3d-on-torngat">
<h1>… run E3d on Torngat<a class="headerlink" href="#run-e3d-on-torngat" title="Permalink to this headline">¶</a></h1>
<div class="section" id="how-to-run-e3d-on-torngat">
<h2>How to run E3d on Torngat<a class="headerlink" href="#how-to-run-e3d-on-torngat" title="Permalink to this headline">¶</a></h2>
<p>08 Jan 2013</p>
<p>This note describes how to run E3d on the Torngat cluster.</p>
<p>E3d is a computer program for simulating seismic waves in an elastic medium. Simulation parameters
are specified in an input parameter file. Simple models of the elastic medium (earth model) can be
specified in the input parameter file. More complex models must be specified in a separate set of files
known as vfiles. The simulated acoustic waves are output as seismic trace files and/or image files.</p>
<p>The elastic medium is modeled as a box shaped set of uniformly spaced points referred to as a grid. The
grid is defined in a left handed coordinate system (positive z axis pointing down).</p>
<img alt="../../_images/grid.png" class="align-center" src="../../_images/grid.png" />
<p>The input parameter file is an ascii (text) file containing a series of commands. Each command consists
of a keyword followed by one or more parameter-value pairs. The basic commands are as follows:</p>
<dl class="simple">
<dt>grid</dt><dd><p>specifies the grid dimensions and boundary conditions</p>
</dd>
<dt>time</dt><dd><p>specifies the simulation time, step interval</p>
</dd>
<dt>source</dt><dd><p>specifies the source location, source waveform, source time delay</p>
</dd>
<dt>block</dt><dd><p>specifies the velocity, density for a specified block of the grid</p>
</dd>
<dt>parallel</dt><dd><p>specifies the partitioning of the model grid for parallelization</p>
</dd>
<dt>traces</dt><dd><p>specifies the geometry of the receivers for a seismic line</p>
</dd>
</dl>
<p>The grid command specifies the geometry and boundary conditions of the model. The basic parameters
are as follows:</p>
<dl class="field-list">
<dt class="field-odd">l</dt>
<dd class="field-odd"><p>the number of grid points in the y direction [required]</p>
</dd>
<dt class="field-even">m</dt>
<dd class="field-even"><p>the number of grid points in the z direction [required]</p>
</dd>
<dt class="field-odd">n</dt>
<dd class="field-odd"><p>the number of grid points in the x direction [required]</p>
</dd>
<dt class="field-even">dh</dt>
<dd class="field-even"><p>the grid point spacing in all directions (in kilometers)</p>
</dd>
<dt class="field-odd">b</dt>
<dd class="field-odd"><p>grid boundary conditions</p>
<p>1 = reflecting</p>
<p>2 = absorbing</p>
<p>3 = surface [default]</p>
<p>4 = surface modified for acoustic instabilities</p>
</dd>
</dl>
<p>To demonstrate how to use E3d we consider an earth model which is 1 kilometer by 1 kilometer by 1
kilometer (a cube). We will set the grid point spacing to 2.5 meters. The grid dimensions are thus 401
by 401 by 401 points, a grid size of approximately 64 million points.</p>
<p>We choose to make the surface reflecting and the sides and bottom of the grid absorbing so we use b=3
which is the default so we do not need to specify it explicitly. The grid command will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span> <span class="n">l</span><span class="o">=</span><span class="mi">401</span> <span class="n">m</span><span class="o">=</span><span class="mi">401</span> <span class="n">n</span><span class="o">=</span><span class="mi">401</span> <span class="n">dh</span><span class="o">=</span><span class="mf">0.0025</span>
</pre></div>
</div>
<p>Note there must not be any spaces on either side of the equal signs.</p>
<p>The time command time simulation time and the simulation time step interval. The basic parameters
are as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">t</dt>
<dd class="field-odd"><p>number of time-steps [required]</p>
</dd>
<dt class="field-even">dt</dt>
<dd class="field-even"><p>time-stepping increment (seconds) [required]</p>
</dd>
</dl>
<p>We will set up the job to solve the wave equation for a time duration of ½ second. We choose a time
step size of 0.2 milliseconds. 2500 time steps are required for a time duration of ½ second.</p>
<p>The time command will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">t</span><span class="o">=</span><span class="mi">2500</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.000200</span>
</pre></div>
</div>
<p>The source command describes the source function and position. The basic parameters are as follows:</p>
<dl class="field-list">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p>source type [required]</p>
<p>1=P wave</p>
<p>2=S wave</p>
<p>4=Moment Tensor</p>
<p>5=Force</p>
<p>6=Fault (point source)</p>
<p>7=Fault (finite length)</p>
<p>8=Distributed Slip (from file)</p>
<p>9=Distributed Slip (from file with rise-times)</p>
</dd>
<dt class="field-even">amp</dt>
<dd class="field-even"><p>amplitude of source (in dyne-cm) [required]</p>
</dd>
<dt class="field-odd">freq</dt>
<dd class="field-odd"><p>central frequency of source in Hz [default = 1.0]</p>
</dd>
<dt class="field-even">t0</dt>
<dd class="field-even"><p>shift in start time of the source in seconds [default = 0]</p>
</dd>
<dt class="field-odd">x</dt>
<dd class="field-odd"><p>x position of source (kilometers) [default = center of grid]</p>
</dd>
<dt class="field-even">y</dt>
<dd class="field-even"><p>y position of source (kilometers) [default = center of grid]</p>
</dd>
<dt class="field-odd">z</dt>
<dd class="field-odd"><p>z position of source (kilometers) [default = center of grid]</p>
</dd>
</dl>
<p>For our example we choose to position the source on the surface in the center of the model.</p>
<img alt="../../_images/sourceposition.png" class="align-center" src="../../_images/sourceposition.png" />
<p>The model is a 1 km cube, so we set the source position as x=0.5 km, y=0.5 km, z=0 km, at the surface.
We choose a compressional source (P wave) so we set type=1. The source function is a Ricker wavelet.
We choose a center frequency of 40 Hertz so we set freq=40.0. We set the source amplitude to 1.0 x
10+27 dynes (this is rather arbitrary). The time shift is an important parameter. The default is zero
which will cause ringing artifacts in the simulated waves. We use a nominal shift of 25 milliseconds to
minimize ringing so we set t=0.025. The source command will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span> <span class="n">amp</span><span class="o">=</span><span class="mf">1.e27</span> <span class="n">freq</span><span class="o">=</span><span class="mf">40.0</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.025</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.000</span>
</pre></div>
</div>
<p>The block command describes the velocity, density and attenuation of the model at each grid point
within a specified block (sub-region) of the grid. The basic parameters are as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">p</dt>
<dd class="field-odd"><p>p-wave velocity (km/sec) [default = none]</p>
</dd>
<dt class="field-even">s</dt>
<dd class="field-even"><p>s-wave velocity (km/sec) [default = none]</p>
</dd>
<dt class="field-odd">r</dt>
<dd class="field-odd"><p>density (g/cm**3) [default = none]</p>
</dd>
<dt class="field-even">l1</dt>
<dd class="field-even"><p>index of first grid point of block element in y dimension [ default = 0]</p>
</dd>
<dt class="field-odd">l2</dt>
<dd class="field-odd"><p>index of last grid point of block element in y dimension [default = end of grid]</p>
</dd>
<dt class="field-even">m1</dt>
<dd class="field-even"><p>index of first grid point of block element in z dimension [default = 0]</p>
</dd>
<dt class="field-odd">m2</dt>
<dd class="field-odd"><p>index of last grid point of block element in z dimension [default = end of grid]</p>
</dd>
<dt class="field-even">n1</dt>
<dd class="field-even"><p>index of first grid point of block element in x dimension [default = 0]</p>
</dd>
<dt class="field-odd">n2</dt>
<dd class="field-odd"><p>index of last grid point of block element in x dimension [default = end of grid]</p>
</dd>
</dl>
<p>We choose a simple two layer model for the purpose of demonstrating how to specify the model.</p>
<img alt="../../_images/twolayer.png" class="align-center" src="../../_images/twolayer.png" />
<p>We will model the top layer with a p-wave velocity of 4 km/sec so we set p=4.0. We model the top
layer with s-wave velocity of 2/3 the p-wave velocity so we set s=2.67 . We set the top layer density to
2.5 grams per cubic centimeter with r=2.5 . We will consider these attributes to be the background. We
initially model the entire grid as background like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">block</span> <span class="n">p</span><span class="o">=</span><span class="mf">4.0</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.67</span> <span class="n">r</span><span class="o">=</span><span class="mf">2.5</span>
</pre></div>
</div>
<p>We now model the second layer. We will model the p-wave velocity of the lower layer to be 6 km/sec,
the s-wave velocity to be 4 km/sec and the density to be 2.5 grams per cc by setting s=6.0, s=4.0 and
r=2.5 . The top of the lower layer is ½ kilometre below the surface so we set m1=200 which is halfway
down the z axis. The bottom of the lower layer is at the bottom of the grid so we set m2=400 which the
last point on the z axis. The sides of the lower layer are the sides of the grid. The block command for
the second layer is thus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">block</span> <span class="n">p</span><span class="o">=</span><span class="mf">4.0</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.67</span> <span class="n">r</span><span class="o">=</span><span class="mf">2.5</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">200</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span>
</pre></div>
</div>
<p>Each successive block can potentially overwrite the grid points of preceeding blocks. In our case the
second block overwrote the lower half of the background defined in the first block command.</p>
<p>E3D can simulate the seismic signal at specified receiver locations in the grid.</p>
<p>E3D can simulate the seismic signal at specified receiver locations in the grid.
The traces command is used to specify a line of receivers. The basic parameters are as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">mode</dt>
<dd class="field-odd"><p>bitwise component(s) to output (1=Vx;2=Vy;4=Vz;8=P;16=S) [default=31 (all)]</p>
</dd>
<dt class="field-even">sample</dt>
<dd class="field-even"><p>time sub-sampling factor for traces [default=1]</p>
</dd>
<dt class="field-odd">file</dt>
<dd class="field-odd"><p>file name header of traces file [default=”traces”]</p>
</dd>
<dt class="field-even">x1</dt>
<dd class="field-even"><p>starting x coordinate for traces (km) [default=0.]</p>
</dd>
<dt class="field-odd">x2</dt>
<dd class="field-odd"><p>ending x coordinate for traces (km) [default=0.]</p>
</dd>
<dt class="field-even">y1</dt>
<dd class="field-even"><p>starting y coordinate for traces (km) [default=0.]</p>
</dd>
<dt class="field-odd">y2</dt>
<dd class="field-odd"><p>ending y coordinate for traces (km) [default=0.]</p>
</dd>
<dt class="field-even">p</dt>
<dd class="field-even"><p>number of traces along coordinate line (inclusive) [default=0]</p>
</dd>
</dl>
<p>The trace command can specify one line of receivers. A separate trace command is required for each
line of receivers. We will orient the lines parallel to the y axis by specifying the endpoints y1=0.000
and y2=1.000 . To position the first line on the x axis at x=0 we specify x1=0.0 and x2=0.0 . We specify
a receiver at every other grid point by setting the number of receviers p=201 . The recevier spacing will
thus be 5 meters in our example. The traces for a line of receivers will be output in a file. A separate
file is written for each seismic line. We identify the x position of the line in the file name prefix by
specifying file=”traces/line.x.0000”. This also specifies that the file be written in a sub-directory called
<em>traces</em>. We will output trace samples every 5-th time step by specifying sample=5 . Since the time step
is 200 micro-seconds then the sample interval will be 1 millisecond. We will record the pressure wave
at each recevier so we set mode=8. The trace card for the first line looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>traces mode=8 sample=5 file=”traces/line.x.000” p=201 \
    x1=0.000 x2=0.000 y1=0.000 y2=1.000
</pre></div>
</div>
<p>The backslash character is used to continue a command onto the next line of text in the parameter file.</p>
<p>We want a seismic line at every other grid point along the x axis which will require 201 trace
commands. This would be tedious to do by hand so we write a program (or a script) to do this for us.
The following C program will do the trick:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="cm">/*********************************************************************************</span>
<span class="cm"> This program creates a set of trace cards for E3D. The trace cards describe</span>
<span class="cm"> a seismic line layout on the surface of a rectangle. The rectangle size is</span>
<span class="cm"> L x N points. The point spacing is dh. The geophones are laid out in the</span>
<span class="cm"> y dimension on every grid point in a straight line. The grid spacing is dh.</span>
<span class="cm"> *********************************************************************************/</span>

 <span class="cp">#define L 201 </span><span class="c1">// number of receivers per line</span>
 <span class="cp">#define N 201 </span><span class="c1">// number of seismic lines</span>
 <span class="cp">#define ds 5.0 </span><span class="c1">// receiver spacing (meters)</span>

 <span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

 <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">argv</span><span class="p">[])</span>
 <span class="p">{</span>
     <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;tracecards&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;cannot open file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

     <span class="kt">float</span> <span class="n">y1</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// position of 1st geophone on the line</span>
     <span class="kt">float</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">((</span><span class="kt">float</span><span class="p">)((</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span> <span class="c1">// position of last geophone (km)</span>

     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">// for each line on the x axis</span>
     <span class="p">{</span>
         <span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">ds</span><span class="p">;</span> <span class="c1">// position of seismic line on the x axis (meters)</span>
         <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">ix</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span> <span class="c1">// position of seismic line on x axis (km)</span>
         <span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">&quot;traces mode=8 sample=5 file=</span><span class="se">\&quot;</span><span class="s">traces/line.x.%04d</span><span class="se">\&quot;</span><span class="s"> p=%d </span><span class="se">\\\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">ix</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>
         <span class="n">fprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">&quot; x1=%5.3f x2=%5.3f y1=%5.3f y2=%5.3f z1=0.000 z2=0.000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>
     <span class="p">};</span>

     <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">fclose</span> <span class="p">(</span><span class="n">file</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error writing output file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

     <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Call the C program <em>traces.c</em>.</p>
<p>Compile and run the C-program in a shell like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cc -std=c99 traces.c -o traces
$ ./traces
</pre></div>
</div>
<p>The program creates an ascii file called tracecards. The contents of the file look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0005&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0010&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
            <span class="o">.....</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0990&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0995&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.1000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
</pre></div>
</div>
<p>There are 201 trace commands in the file, one for every line along the x axis. Note that each command
is specified on two lines of text in the parameter file using the continuation character ‘'.</p>
<p>We are going to run E3d on the Torngat cluster. We will instruct E3d to divide the model grid into subvolumes
of identical size. Each sub-volume will be processed by a separate core of the cluster. The
more sub-volumes, the faster the job will run.</p>
<p>The <em>parallel</em> command specifies the way the model grid will be sub-divided (partitioned) for execution
in a parallel environment. There are three parameters:</p>
<dl class="field-list simple">
<dt class="field-odd">nx</dt>
<dd class="field-odd"><p>number of partitions in the x dimension [default = 1]</p>
</dd>
<dt class="field-even">ny</dt>
<dd class="field-even"><p>number of partitions in the y dimension [default = 1]</p>
</dd>
<dt class="field-odd">nz</dt>
<dd class="field-odd"><p>number of partitions in the z dimension [default = 1]</p>
</dd>
</dl>
<p>We will sub-divide the y and z dimensions into 8 partitions each but leave the x dimension undivided.
This partitioning scheme results in 64 sub-volumes. The parallel command looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parallel</span> <span class="n">nx</span><span class="o">=</span><span class="mi">1</span> <span class="n">ny</span><span class="o">=</span><span class="mi">8</span> <span class="n">nz</span><span class="o">=</span><span class="mi">8</span>
</pre></div>
</div>
<p>We put all the commands in the input parameter text file which we call layers.e3d. The contents of the
parameter file looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span> <span class="n">l</span><span class="o">=</span><span class="mi">401</span> <span class="n">m</span><span class="o">=</span><span class="mi">401</span> <span class="n">n</span><span class="o">=</span><span class="mi">401</span> <span class="n">dh</span><span class="o">=</span><span class="mf">0.002500</span>
<span class="n">time</span> <span class="n">t</span><span class="o">=</span><span class="mi">2500</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.000200</span>
<span class="n">source</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span> <span class="n">freq</span><span class="o">=</span><span class="mi">40</span> <span class="n">amp</span><span class="o">=</span><span class="mf">1.00e+27</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.025</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">block</span> <span class="n">p</span><span class="o">=</span><span class="mf">4.0</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.67</span> <span class="n">r</span><span class="o">=</span><span class="mf">2.5</span>
<span class="n">block</span> <span class="n">p</span><span class="o">=</span><span class="mf">6.0</span> <span class="n">s</span><span class="o">=</span><span class="mf">4.00</span> <span class="n">r</span><span class="o">=</span><span class="mf">2.5</span> \
<span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">200</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span>
<span class="n">parallel</span> <span class="n">nx</span><span class="o">=</span><span class="mi">1</span> <span class="n">ny</span><span class="o">=</span><span class="mi">8</span> <span class="n">nz</span><span class="o">=</span><span class="mi">8</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0005&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0010&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
            <span class="o">.....</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0990&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0995&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.1000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
    <span class="n">x1</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
</pre></div>
</div>
<p>The job will be submitted to the cluster using the Sun N1 Grid Engine. The job is specified in an ascii
text file. We refer to this file as the job deck. The job deck for our E3d run will look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -cwd</span>
<span class="c1">#$ -N layers</span>
<span class="c1">#$ -o layers.output -j y</span>
<span class="c1">#$ -pe impi 64</span>
<span class="c1">#$ -l qname=all.q</span>
<span class="c1">#$ -V</span>

MakeMachineFile<span class="o">()</span>
<span class="o">{</span>
    cat <span class="nv">$1</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
        <span class="nv">host</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot; &quot;</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot;.&quot;</span><span class="sb">`</span>
        <span class="nv">nprocs</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f2 -d<span class="s2">&quot; &quot;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$nprocs</span><span class="s2">&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>
MakeMachineFile <span class="nv">$PE_HOSTFILE</span> &gt;machines.<span class="nv">$JOB_ID</span>

mpiexec.hydra --machinefile<span class="o">=</span>machines.<span class="nv">$JOB_ID</span> /home/gblades/bin/e3d layers.e3d

rm machines.<span class="nv">$JOB_ID</span>
</pre></div>
</div>
<p>The job deck is in a file we will call <code class="docutils literal notranslate"><span class="pre">layers.ge</span></code>.</p>
<p>The directives section specifies the computing environment and resources that are needed to do the job.
Each directive starts with #$ . There must be no space before the #$ but there should be a space after.</p>
<p>We specify that we want to execute the commands in the current directory with the -cwd directive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -cwd</span>
</pre></div>
</div>
<p>We specify the name of the job with the -N directive. We use the name cube:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -N layers</span>
</pre></div>
</div>
<p>E3d will write to standard output and standard error and we direct that output into a file. We choose the
name layers.output for the output file and we merge standard output and standard error into one stream
with this directive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -o layers.output -j y</span>
</pre></div>
</div>
<p>We are going to run in a parallel environment. We will distribute the job over 64 cores. The parallel
environment directive looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -pe impi 64</span>
</pre></div>
</div>
<p>The number in the parallel environment (pe) directive specifies the number of cores to assign to E3d.
This number must equal the number of sub-volumes specified in the parallel command in the input
parameter file.</p>
<p>We specify the job queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -l qname=all.q</span>
</pre></div>
</div>
<p>We specify that the job have the same environment variables as the shell in which the job is submitted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -V</span>
</pre></div>
</div>
<p>We will run the job from a local directory on the master node of the Torngat cluster. So log in to
Torngat:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh yourid@torngat.creait.mun.ca
</pre></div>
</div>
<p>On Torngat we create a directory where we will run the job. We will create a directory called layers for
our sample job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir traces
</pre></div>
</div>
<p>The input parameter file and job deck are to be copied to the traces directory on Torngat. Use a host-tohost
copy command to copy these files from your workstation or personal computer to Torngat:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ scp layers.e3d yourid@torngat.creait.mun.ca:~/traces
$ scp layers.ge yourid@torngat.creait.mun.ca:~/traces
</pre></div>
</div>
<p>On Torgat verify the files are there:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd traces
$ ls
layers.e3d layers.ge
</pre></div>
</div>
<p>In this directory we must create the sub-directory used by E3d to write the seismic trace files. So in the
layers directory we create sub-directory traces for the seismic output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir traces
$ ls
layers.e3d layers.ge traces
</pre></div>
</div>
<p>We are now ready to submit the job. The qsub command is used to submit jobs to the grid engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qsub layers.ge
</pre></div>
</div>
<p>The grid engine will respond:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Your</span> <span class="n">job</span> <span class="n">layers</span> <span class="n">has</span> <span class="n">been</span> <span class="n">submitted</span>
</pre></div>
</div>
<p>We can check on the status of the job using the qstat command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qstat
job-ID   prior    name     user    state  submit/start at      queue                      slots
-----------------------------------------------------------------------------------------------------
1810021  0.56688  layers   yourid  r      11/14/2012 13:22:24  all.q@cl032.mun.acenet.ca  64
</pre></div>
</div>
<p>Use the qstat command periodically to check the status of the job. When the job is finished it will no
longer be reported.
The output from the job will be written to the directory in which the job was submitted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
layers.e3d layers.ge layers.output traces
</pre></div>
</div>
<p>The file layers.output contains messages from E3d. This file should be checked after the job is
finished. There will be a section in the output file that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Courant</span> <span class="n">condition</span> <span class="n">requires</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="n">ct</span>
<span class="o">----------------------------------</span>
<span class="n">dt</span>    <span class="o">=</span> <span class="mf">0.000400</span>
<span class="n">ct</span>    <span class="o">=</span> <span class="mf">0.000412</span>
<span class="n">ct</span><span class="o">/</span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.03</span>
</pre></div>
</div>
<p>If the ratio ct/dt is less than 1.0 then the job did not run.</p>
<p>The time step dt must satisfy the Courant condition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">0.606</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">/</span> <span class="n">Vmax</span> <span class="p">(</span><span class="k">for</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">0.494</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">/</span> <span class="n">Vmax</span> <span class="p">(</span><span class="k">for</span> <span class="mi">3</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<p>where dh is the grid spacing and Vmax is the maximum (P) velocity in the grid.</p>
<p>If the job did not run because of the Courant condition, adjust the values of dt and/or dh until the
Courant condition is satisfied and re-submit the job.</p>
<p>The traces directory will contain the seismic traces recorded during the simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls traces
line.x.0000.0.TP line.x.0335.67.TP line.x.0670.134.TP
line.x.0005.1.TP line.x.0340.68.TP line.x.0675.135.TP
   ... ... ... ... ...
   ... ... ... ... ...
line.x.0325.65.TP line.x.0660.132.TP line.x.0995.199.TP
line.x.0330.66.TP line.x.0665.133.TP line.x.1000.200.TP
</pre></div>
</div>
<p>The traces for each seismic line are in one file in a multiplexed format peculiar to E3d. These
multiplexed files must be converted to a sequential binary file format suitable for use with industry
standard seismic programs. The bintrace command is used to perform the conversion. Execute this
command in the directory which contains the traces sub-directory (eg, not in the traces directory, above
it):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /home/gblades/bin/bintraces
</pre></div>
</div>
<p>The result will be a directory bintraces which contains the demultiplexed traces in binary format. The
trace files need to transfered to a local workstation so we can view them as a seismic section. Copy the
trace files into a single file for copying. We create a tape archive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tar cvf bintraces.tar bintraces
</pre></div>
</div>
<p>Copy the bintraces tape archive to your local workstation. On your local workstation or personal
computer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ scp yourid@torngat.creait.mun.ca:~/traces/bintraces.tar .
</pre></div>
</div>
<p>Unpack the archive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tar xvf bintraces.tar
</pre></div>
</div>
<p>The result will be a directory called bintraces with the seismic trace files.
We now add headers to the traces. Seismic Unix can be used to perform this task. The traces can now
be viewed in visualization programs such as GeoProbe.</p>
<p>Real world models are more complex than can be constructed with blocks. Such models must be
generated by separate programs. These models are supplied to E3d as grid files. Separate files are
required for the p-velocity, s-velocity and density grids.</p>
<img alt="../../_images/densitygrids.png" class="align-center" src="../../_images/densitygrids.png" />
<p>A computer program can be used to construct a model and output it as grid files. The following C
program illustrates how to create the grid files required for our two layer model.</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

 <span class="cp">#define BASENAME &quot;layers&quot;</span>

 <span class="cp">#define L 401</span>
 <span class="cp">#define M 401</span>
 <span class="cp">#define N 401</span>

 <span class="cp">#define P1 4.00</span>
 <span class="cp">#define S1 2.67</span>
 <span class="cp">#define R1 2.30</span>

 <span class="cp">#define P2 6.00</span>
 <span class="cp">#define S2 4.00</span>
 <span class="cp">#define R2 2.50</span>

 <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
 <span class="p">{</span>
     <span class="kt">float</span> <span class="o">*</span><span class="n">slice</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slice</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">printf</span><span class="p">(</span><span class="s">&quot;can&#39;t create buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">mode</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="c1">// for p, s, r</span>
     <span class="p">{</span>
         <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;model/%s.p&quot;</span><span class="p">,</span> <span class="n">BASENAME</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;model/%s.s&quot;</span><span class="p">,</span> <span class="n">BASENAME</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;model/%s.r&quot;</span><span class="p">,</span> <span class="n">BASENAME</span><span class="p">);</span>

         <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">);</span>

         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;can&#39;t create file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>

         <span class="kt">float</span> <span class="n">layer1</span><span class="p">,</span> <span class="n">layer2</span><span class="p">;</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">layer1</span><span class="o">=</span><span class="n">P1</span><span class="p">;</span> <span class="n">layer2</span><span class="o">=</span><span class="n">P2</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// p velocity</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">layer1</span><span class="o">=</span><span class="n">S1</span><span class="p">;</span> <span class="n">layer2</span><span class="o">=</span><span class="n">S2</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// s velocity</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="n">layer1</span><span class="o">=</span><span class="n">R1</span><span class="p">;</span> <span class="n">layer2</span><span class="o">=</span><span class="n">R2</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// density</span>

         <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// slice index</span>

         <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iy</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">iy</span><span class="o">&lt;</span><span class="n">L</span><span class="p">;</span> <span class="n">iy</span><span class="o">++</span><span class="p">)</span> <span class="c1">// for each grid point on y axis</span>
         <span class="p">{</span>
             <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">iz</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">iz</span><span class="o">&lt;</span><span class="n">M</span><span class="p">;</span> <span class="n">iz</span><span class="o">++</span><span class="p">)</span> <span class="c1">// for each grid point on z axis</span>
             <span class="p">{</span>
                 <span class="kt">float</span> <span class="n">value</span><span class="p">;</span>

                 <span class="k">if</span> <span class="p">(</span><span class="n">iz</span> <span class="o">&lt;</span> <span class="n">M</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="n">value</span> <span class="o">=</span> <span class="n">layer1</span><span class="p">;</span>
                 <span class="k">else</span>          <span class="n">value</span> <span class="o">=</span> <span class="n">layer2</span><span class="p">;</span>

                 <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ix</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ix</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="c1">// for each point on x axis</span>
                 <span class="p">{</span>
                     <span class="n">slice</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
                     <span class="n">j</span><span class="o">++</span><span class="p">;</span> <span class="c1">// next point in model</span>
                 <span class="p">}</span>
             <span class="p">}</span>
             <span class="kt">int</span> <span class="n">nwords</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">slice</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">nwords</span> <span class="o">!=</span> <span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;can&#39;t write slice (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">M</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">nwords</span><span class="p">);</span>

             <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// first point in model</span>

         <span class="p">}</span> <span class="c1">// end for islice</span>

         <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

      <span class="p">}</span> <span class="c1">// end for p, s, r</span>

     <span class="n">free</span><span class="p">(</span><span class="n">slice</span><span class="p">);</span>
     <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

 <span class="p">}</span> <span class="c1">// end main()</span>
</pre></div>
</td></tr></table></div>
<p>We name the program file layers.c . And compile and run the C-program in a shell like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cc -std=c99 layers.c -o layers
$ ./layers
</pre></div>
</div>
<p>The program creates the three grid files in a sub-directory called model</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls model
layers.p layers.r layers.s
</pre></div>
</div>
<p>If the files are on your personal computer, transfer them to the traces directory on Torngat</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls
layers.e3d layers.ge model traces
</pre></div>
</div>
<p>The vfile command specifies how to load and position a grid file into the model in E3d. The basic
parameters are as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p>input file type (p, s, r) [default = none]</p>
</dd>
<dt class="field-even">file</dt>
<dd class="field-even"><p>name of the grid file [required]</p>
</dd>
<dt class="field-odd">l1</dt>
<dd class="field-odd"><p>index of first grid point in y dimension of the model [required]</p>
</dd>
<dt class="field-even">l2</dt>
<dd class="field-even"><p>index of last grid point in y dimension of the model l [ required]</p>
</dd>
<dt class="field-odd">m1</dt>
<dd class="field-odd"><p>index of first grid point in z dimension of the model [required]</p>
</dd>
<dt class="field-even">m2</dt>
<dd class="field-even"><p>index of last grid point in z dimension of the model [required]</p>
</dd>
<dt class="field-odd">n1</dt>
<dd class="field-odd"><p>index of first grid point in x dimension of the model [required]</p>
</dd>
<dt class="field-even">n2</dt>
<dd class="field-even"><p>index of last grid point in x dimension of the model [required]</p>
</dd>
</dl>
<p>The our two layer example the grid files are the same size and dimensions as the model. So the vfile
commands look like this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">p</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.p&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">s</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.s&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">r</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.r&quot;</span>
</pre></div>
</div>
<p>The vfile commands replace the block commands in the input parameter file layers.e3d. The contents
of the parameter file now looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span> <span class="n">l</span><span class="o">=</span><span class="mi">401</span> <span class="n">m</span><span class="o">=</span><span class="mi">401</span> <span class="n">n</span><span class="o">=</span><span class="mi">401</span> <span class="n">dh</span><span class="o">=</span><span class="mf">0.002500</span>
<span class="n">time</span> <span class="n">t</span><span class="o">=</span><span class="mi">2500</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.000200</span>
<span class="n">source</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span> <span class="n">freq</span><span class="o">=</span><span class="mi">40</span> <span class="n">amp</span><span class="o">=</span><span class="mf">1.00e+27</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.025</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.500</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">p</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.p&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">s</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.s&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">r</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers.r&quot;</span>
<span class="n">parallel</span> <span class="n">nx</span><span class="o">=</span><span class="mi">1</span> <span class="n">ny</span><span class="o">=</span><span class="mi">8</span> <span class="n">nz</span><span class="o">=</span><span class="mi">8</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0005&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.005</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0010&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.010</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
                 <span class="o">.....</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0990&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.990</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.0995&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">x2</span><span class="o">=</span><span class="mf">0.995</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
<span class="n">traces</span> <span class="n">mode</span><span class="o">=</span><span class="mi">8</span> <span class="n">sample</span><span class="o">=</span><span class="mi">5</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;traces/line.x.1000&quot;</span> <span class="n">p</span><span class="o">=</span><span class="mi">201</span> \
     <span class="n">x1</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">x2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.000</span> <span class="n">z1</span><span class="o">=</span><span class="mf">0.000</span> <span class="n">z2</span><span class="o">=</span><span class="mf">0.000</span>
</pre></div>
</div>
<p>The job can be submitted to the cluster as before. Any existing files in the traces sub-directory should
be deleted before submitting the job.</p>
<p>There is a limitation when using grid files. The size of an individual grid file cannot exceed 2.048 GB.
This corresponds to about 500K grid points. In such cases the grid must be split into multiple files each
less than the maximum size. A vfile command must be specified in the parameter deck for each grid
file. It is convenient to split the grid into multilple blocks along the y-axis.</p>
<p>As an example we could split the two layer model into two pieces along the y axis at about the mid
point (even though it does not exceed the size limit). The grid files could be numbered to identify the
pieces.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls model
layers-1.p layers-1.r layers-1.s
layers-2.p layers-2.r layers-2.s
</pre></div>
</div>
<p>A vfile command would then be specified for each of the grid files.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">p</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">199</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-1.p&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">s</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">199</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-1.s&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">r</span> <span class="n">l1</span><span class="o">=</span><span class="mi">0</span> <span class="n">l2</span><span class="o">=</span><span class="mi">199</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-1.r&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">p</span> <span class="n">l1</span><span class="o">=</span><span class="mi">200</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-2.p&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">s</span> <span class="n">l1</span><span class="o">=</span><span class="mi">200</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-2.s&quot;</span>
<span class="n">vfile</span> <span class="nb">type</span><span class="o">=</span><span class="n">r</span> <span class="n">l1</span><span class="o">=</span><span class="mi">200</span> <span class="n">l2</span><span class="o">=</span><span class="mi">400</span> <span class="n">m1</span><span class="o">=</span><span class="mi">0</span> <span class="n">m2</span><span class="o">=</span><span class="mi">400</span> <span class="n">n1</span><span class="o">=</span><span class="mi">0</span> <span class="n">n2</span><span class="o">=</span><span class="mi">400</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;model/layers-2.r&quot;</span>
</pre></div>
</div>
<p>The E3d job could be run as before.</p>
<p>The Facet Modeller program can be also used to construct a model for E3d.</p>
<p>The two layer model can be constructed as a facet model (see the user manual for Facet Modeller).</p>
<img alt="../../_images/facetmodel.png" class="align-center" src="../../_images/facetmodel.png" />
<p>The facet model can be converted to a rectilinear grid using the built-in gridding procedure.
The program requires additional data for the gridding procedure which is supplied as two files:</p>
<ol class="arabic simple">
<li><p>regions file</p></li>
<li><p>rocks file</p></li>
</ol>
<p>The regions file is an ascii text file specifying a rock id for each structure (region) in the model. In our
two layer example we have two regions: 1) an upper layer (background) and 2) a lower layer. Each
region is specified in one line in the file. Each line consists of six tokens specifying region number,
coordinate of a point inside the region, rock type (id) associated with the region and a comment
(optional). Regions must be numbered sequentially starting at 1. Rock types (id) must be sequential
integers starting at 0. The rock type with id=0 is considered to be the default rock type or background.</p>
<img alt="../../_images/regionfile.png" class="align-center" src="../../_images/regionfile.png" />
<p>The regions file root name must be the same as the project name with extension “regions”. The regions
file must be located in the Facet Modeller project directory.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ more layers.regions

1 500 500 250 0 #Background
2 500 500 750 1 #Layer
</pre></div>
</div>
<p>The rocks file is an ascii text file specifying the geophysical properties (attributes) for each rock type.
In our two layer example we have two rock types: 1) upper layer or background rock (id=0), 2) lower
layer rock (id=1). Three attributes are required for each rock type: 1) p-velocity (k/sec), 2) s-velocity
(k/sec) and 3) density (g/cm3). The rock ids must be ordered sequenitally starting at 0.</p>
<img alt="../../_images/rocks.png" class="align-center" src="../../_images/rocks.png" />
<p>The rocks file name is specified in the gridding dialog. It must have the extension “rocks”. The rocks
file must be located in the Facet Modeller project directory.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ more layers.rocks

0 p=4.0 s=2.66 r=2.5 #Background
1 p=6.0 s=4.00 r=2.5 #Layer
</pre></div>
</div>
<p>The gridding procedure is invoked with the Grid button in the main toolbar of Facet Modeller.</p>
<img alt="../../_images/facetmodeler.png" class="align-center" src="../../_images/facetmodeler.png" />
<p>The grid boundaries and grid point spacing are specified in the gridding dialog along with the name of
the rocks file. The name of the output grid files can also be specified. The gridding procedure is
invoked by pressing the Grid button. Depending on the complexity and size of the model it may take
Facet Modeller considerable time to create the grid model. The following files are generated:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>grid files (one each for attributes p, s, r)</p></li>
<li><p>vfile command specification for the E3d parameters deck</p></li>
<li><p>log file for the grid conversion process</p></li>
</ol>
</div></blockquote>
<p>The output grid files are located in a directory named model in the Facet Modeller project directory.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls model

layers.p layers.r layers.s
</pre></div>
</div>
<p>The vfile command specification file is output in the Facet Modeller project directory. It has a root
name the same as the project name with extension vfile.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ more layers.vfile

vfile type=p l1=0 l2=400 m1=0 m2=400 n1=0 n2=400 file=&quot;model/layers.p&quot;
vfile type=s l1=0 l2=400 m1=0 m2=400 n1=0 n2=400 file=&quot;model/layers.s&quot;
vfile type=r l1=0 l2=400 m1=0 m2=400 n1=0 n2=400 file=&quot;model/layers.r&quot;
</pre></div>
</div>
<p>The vfile command specification is to be copied and pasted into the E3d parameter file as in the
previous example.</p>
<p>The E3d job can be run as before.</p>
<p>If the model size exceeds the 500K grid point limit for a single file then Facet Modeller will
automatically split the grid into multiple files as necessary and generate the appropriate vfile
commands for E3d.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../unusual.html" class="btn btn-neutral float-right" title="… run unusual code on Torngat" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../impi/mpi-helloworld.html" class="btn btn-neutral float-left" title="MPI Communications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Memorial University of Newfoundland

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>