

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>… run unusual code on Torngat &mdash; Torngat cluster  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="… run E3d on Torngat" href="e3d/e3d.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Torngat cluster
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How do I …</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getatorngataccount.html">… get a Torngat account?</a></li>
<li class="toctree-l2"><a class="reference internal" href="transferdatatoacenet.html">… transfer data to/from ACE-net</a><ul>
<li class="toctree-l3"><a class="reference internal" href="transferdatatoacenet.html#tips">Tips</a></li>
<li class="toctree-l3"><a class="reference internal" href="transferdatatoacenet.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="pickaparallelenvironment.html">… pick a parallel environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="pickaparallelenvironment.html#pe-configuration">PE Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="pickaparallelenvironment.html#torngat-pes">Torngat PEs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="matlab.html">… run MATLAB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="matlab.html#accessing-a-matlab-node">Accessing a MATLAB node</a><ul>
<li class="toctree-l4"><a class="reference internal" href="matlab.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="matlab.html#access-instructions">Access instructions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="matlab.html#parallel-computing-in-matlab">Parallel computing in MATLAB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="submit.html">… submit a job on Torngat</a></li>
<li class="toctree-l2"><a class="reference internal" href="useimpi.html">… run Intel MPI programs on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="impi/1selectmpi.html">Select MPI version</a><ul>
<li class="toctree-l4"><a class="reference internal" href="impi/1selectmpi.html#use-the-mpi-selector-facility-to-set-the-mpi-version-to-intel-mpi">Use the mpi selector facility to set the MPI version to Intel MPI.</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="impi/2compile.html">Use the mpi compiler to compile the MPI program</a><ul>
<li class="toctree-l4"><a class="reference internal" href="impi/2compile.html#see-sample-program">See Sample program</a><ul>
<li class="toctree-l5"><a class="reference internal" href="impi/2compile.html#compile-c-program">Compile C program:</a></li>
<li class="toctree-l5"><a class="reference internal" href="impi/2compile.html#compile-c-c-program">Compile C/C++ program:</a></li>
<li class="toctree-l5"><a class="reference internal" href="impi/2compile.html#compile-fortran-program">Compile Fortran program:</a><ul>
<li class="toctree-l6"><a class="reference internal" href="impi/2compile.html#switches-on-the-command-line-are-passed-to-the-underlying-compiler">Switches on the command line are passed to the underlying compiler.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="impi/3submit.html">To run a program in the Intel MPI environment:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="impi/3submit.html#create-a-script-file-describing-the-job">Create a script file describing the job:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="impi/4monitor.html">Monitoring Jobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="impi/4monitor.html#to-show-your-jobs">To show your jobs:</a></li>
<li class="toctree-l4"><a class="reference internal" href="impi/4monitor.html#to-show-all-jobs">To show all jobs:</a></li>
<li class="toctree-l4"><a class="reference internal" href="impi/4monitor.html#to-show-all-queues">To show all queues:</a></li>
<li class="toctree-l4"><a class="reference internal" href="impi/4monitor.html#to-delete-abort-a-job">To delete (abort) a job:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="impi/5output.html">Get the output from the completed job.</a></li>
<li class="toctree-l3"><a class="reference internal" href="impi/6sample.html">Sample Programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="impi/mpi-helloworld.html">MPI Communications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="e3d/e3d.html">… run E3d on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="e3d/e3d.html#how-to-run-e3d-on-torngat">How to run E3d on Torngat</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">… run unusual code on Torngat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-code">“The Code”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-run-it-on-torngat">How to run it on torngat</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="impi/mpi-helloworld.html">MPI Communications</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Torngat cluster</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">How do I …</a> &raquo;</li>
        
      <li>… run unusual code on Torngat</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/howdoi/unusual.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="run-unusual-code-on-torngat">
<h1>… run unusual code on Torngat<a class="headerlink" href="#run-unusual-code-on-torngat" title="Permalink to this headline">¶</a></h1>
<p><em>Tomasz Danek</em></p>
<p><em>June 10, 2013</em></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Running code utilizing “unusual” parallelisation can be tricky on
Torngat supercomputer. Of course the definition of unusual job vary but
in general it can be assumed that any hybrid process-thread code should
be consider as the one. Probably the most commonly used hybrid codes are
the combinations of MPI processes and OMP threads. This short tutorial
presents how to run this kind of code on Torngat.</p>
</div>
<div class="section" id="the-code">
<h2>“The Code”<a class="headerlink" href="#the-code" title="Permalink to this headline">¶</a></h2>
<p>Let us consider the very simple MPI/OMP code creating a matrix which
rows and columns represents process and thread number. Each filed of
matrix is a number with first digit/digits defined by process and last
digit defined by thread number. Please note that presented code does not
present the optimal solution of the problem.</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
 <span class="cp">#include</span> <span class="cpf">&lt;omp.h&gt;</span><span class="cp"></span>

 <span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
 <span class="p">{</span>
 <span class="kt">int</span> <span class="n">my_rank</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="n">n_thr</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x</span><span class="p">;</span>
 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="n">message</span><span class="p">;</span>

 <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>

 <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
 <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_rank</span><span class="p">);</span>
 <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

 <span class="cp">#pragma omp parallel</span>
 <span class="n">n_thr</span><span class="o">=</span><span class="n">omp_get_num_threads</span><span class="p">();</span>

 <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="p">)</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">));</span>
 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
         <span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">n_thr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>

 <span class="cp">#pragma omp parallel private(x)</span>
 <span class="p">{</span>
         <span class="n">x</span><span class="o">=</span><span class="n">omp_get_thread_num</span><span class="p">();</span>
         <span class="n">message</span><span class="p">[</span><span class="n">my_rank</span><span class="p">][</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">my_rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
 <span class="p">{</span>
         <span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_thr</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">if</span> <span class="p">(</span><span class="n">my_rank</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
 <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
         <span class="p">{</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n_thr</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                         <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%d &quot;</span><span class="p">,</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
                 <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="p">}</span>
 <span class="p">}</span>

 <span class="n">MPI_Finalize</span><span class="p">();</span>
 <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Presented code is very simple but let us focus its most important
parallel part. First of all MPI is initialized and then each process
recognize its number (my_rank) and size of the MPI_COMM_WORD
communicator (p). Then number of OMP threads (n_thr) is set. Please
note that by default this value is taken from OMP_NUM_THREAD system
variable. After memory allocation for matrix message the second parallel
section is stared and process dependent row of the matrix if filled with
proper number representing process (first digit) and thread number
(second digit). Then every process broadcast its row to all other
processes so when communication is finished all process have a copy of
the same matrix. Finally process number 0 sends matrix message to
standard error stream.</p>
<p>This code can be compiled using Intel MPI compiler mpiicc (please note
double i):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiicc -O3 -xHOST main.c -openmp
</pre></div>
</div>
</div>
<div class="section" id="how-to-run-it-on-torngat">
<h2>How to run it on torngat<a class="headerlink" href="#how-to-run-it-on-torngat" title="Permalink to this headline">¶</a></h2>
<p>Let us assume that we want run 30 MPI processes and that every process
should start two threads. In a usual real life situation number of
threads should be equal to number of available cores to secure optimal
code efficiency so in this example user should reserve 60 cores. In
current Torngat configuration each node has 12 cores so for this run 5
nodes should be reserved.</p>
<p>To start and interactive session and reserve sufficient resources we
can, for example, use command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>qrsh -cwd -V -q churich.q -pe impi <span class="m">60</span> bash
</pre></div>
</div>
<p>For the explanation of the flags see Torngat user manual.</p>
<p>Then we have to define our own machine file. We can do it using the
script presented bellow:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

MakeMachineFile<span class="o">()</span>
<span class="o">{</span>
  cat <span class="nv">$1</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
     <span class="nv">host</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot; &quot;</span><span class="p">|</span>cut -f1 -d<span class="s2">&quot;.&quot;</span><span class="sb">`</span>
     <span class="nv">nprocs</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span><span class="p">|</span>cut -f2 -d<span class="s2">&quot; &quot;</span><span class="sb">`</span>
     <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$host</span><span class="s2">:</span><span class="nv">$nprocs</span><span class="s2">&quot;</span>
     <span class="nv">np</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$np</span> + <span class="nv">$nprocs</span><span class="sb">`</span>
  <span class="k">done</span>
<span class="o">}</span>

MakeMachineFile <span class="nv">$PE_HOSTFILE</span>
</pre></div>
</div>
<p>After script execution:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>machines &gt; mfile
</pre></div>
</div>
<p>file with something similar to this should be created:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cn32:12
cn24:12
cn15:12
cn16:12
cn07:12
</pre></div>
</div>
<p>Because we do not want to run 60 processes but 30 with 2 threads number
12 should be changed for 6. If you want to run 15 processes using 4
threads you should put 3 after colon.</p>
<p>Now proper script for our run has to be created. Because behavior of -V
flag can be unpredictable in some SGE configuration it is usually safer
to define all used system variables in this script. The simplest
possible script looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">2</span>
./a.out
</pre></div>
</div>
<p>Please note that the first line of the script define the number of the
threads used by every process. If omitted most probably only 1 thread
will be used by every process.</p>
<p>When machine and script files are ready job can be stared using mpi job
starter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec.hydra -machinefile<span class="o">=</span>mfile -np <span class="m">30</span> bash script
</pre></div>
</div>
<p>and the displayed output should be similar to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>10 11
20 21
30 31
40 41
50 51
60 61
70 71
80 81
90 91
100 101
110 111
120 121
130 131
140 141
150 151
160 161
170 171
180 181
190 191
200 201
210 211
220 221
230 231
240 241
250 251
260 261
270 271
280 281
290 291
300 301
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="e3d/e3d.html" class="btn btn-neutral float-left" title="… run E3d on Torngat" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Memorial University of Newfoundland

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>